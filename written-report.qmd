---
title: "The relationship between race, gender, first-gen status, and college type for sleep and GPA in college students"
author: "Wale: Liane, Amy, Eshan, Will"
date: "10/31/24"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
---

```{r}
#| label: load packages and data
library(tidyverse)
library(GGally)
library(knitr)
library(broom)

university_dataset <- read_csv("data/cmu-sleep.csv")
#glimpse(university_dataset)
```

Your written report goes here!

::: callout-important
Before you submit, make sure your code chunks are turned off with `echo: false` and there are no warnings or messages with `warning: false` and `message: false` in the YAML.
:::

Exploratory Data Analysis

Description of the data set and key variables.

The data was originally collected in 2019, with the participants being first-year students at the following three universities: Carnegie Mellon University (CMU), a STEM-focused private university, The University of Washington (UW), a large public university, and Notre Dame University (ND), a private Catholic university. To collect data on sleep, each participating student was given a Fitbit device to track their sleep and physical activity for a month in the spring term, and grade and demographic data was provided by university registrars.

There are 634 observations, representing the 634 participants in this study. Race is a binary variable separated into underrepresented students and non-underrepresented students with 0 being underrepresented and 1 being non-underrepresented. Students are considered underrepresented if either parent is Black, Hispanic or Latino, Native American, or Pacific, and students are deemed non-underrepresented if both parents have White or Asian ancestry. The gender of the subject is also binary with 0 being male and 1 being female. First-generation status is binary with 0 being non-first gen and 1 being first-gen. The mean successive squared difference of bedtime measures the bedtime variability, specifically the average of the squared difference of bedtime on consecutive nights.

```{r}
university_clean <- university_dataset |>
  mutate(university = case_when(
    study %in% c(1, 5) ~ "stem_priv",
    study %in% c(2, 3) ~ "public",
    study == 4 ~ "cath_priv"
  )) |>
  filter(frac_nights_with_data > .50) |>
  filter(demo_firstgen != 2)
#glimpse(university_clean)

# need to continue cleaning for NAs, removing unused variables (ZtoZterm)? also maybe factor(demo firstgen, race, etc)
```

Univariate EDA of The Response & Key Predictor Variables:

```{r}
#| label: univariate-EDA


# university_clean |> 
#   select(term_gpa, cum_gpa, TotalSleepTime, bedtime_mssd, demo_firstgen, university, daytime_sleep) |>
#   ggpairs()

university_clean |>
  ggplot(aes(x = term_gpa)) +
  geom_histogram() +
  labs(title = "Distribution of the Term GPA",
       x = "Term GPA",
       y = "Count")

university_clean |>
  ggplot(aes(x = term_gpa)) +
  geom_histogram() +
  labs(title = "Distribution of the Term GPA by University",
       x = "Term GPA",
       y = "Count") +
  facet_wrap(~university)

university_clean |>
  ggplot(aes(x = cum_gpa)) +
  geom_histogram() +
  labs(title = "Distribution of the Cumulative GPA",
       x = "Cumulative GPA",
       y = "Count")

university_clean |>
  ggplot(aes(x = cum_gpa)) +
  geom_histogram() +
  labs(title = "Distribution of the Cumulative GPA by University",
       x = "Cumulative GPA",
       y = "Count") +
  facet_wrap(~university)

termgpa_ss <- university_clean |>
  group_by(university) |>
  summarize(
    mean_tgpa = mean(term_gpa, na.rm = TRUE),
    median_tgpa = median(term_gpa, na.rm = TRUE),
    sd_tgpa = sd(term_gpa, na.rm = TRUE),
    min_tgpa = min(term_gpa, na.rm = TRUE),
    max_tgpa = max(term_gpa, na.rm = TRUE),
    count = n()
  ) |>
  kable(digits = 3)
termgpa_ss

gpa_ss <- university_clean |>
  group_by(university) |>
  summarize(
    mean_cgpa = mean(cum_gpa, na.rm = TRUE),
    median_cgpa = median(cum_gpa, na.rm = TRUE),
    sd_cgpa = sd(cum_gpa, na.rm = TRUE),
    min_cgpa = min(cum_gpa, na.rm = TRUE),
    max_cgpa = max(cum_gpa, na.rm = TRUE),
    count = n()
  ) |>
  kable(digits = 3)
gpa_ss

university_clean |>
  ggplot(aes(x = TotalSleepTime)) + 
  geom_histogram() +
  labs(title = "Distribution of the Total Sleep Time",
       x = "Total Sleep Time in Minutes", #consider switching to hours
       y = "Count")

university_clean |>
  ggplot(aes(x = bedtime_mssd)) + 
  geom_histogram() +
  labs(title = "Distribution of the Bedtime Variability",
       x = "Mean successive squared difference of bedtime",
       y = "Count")

university_clean |>
  ggplot(aes(x = frac_nights_with_data)) + 
  geom_histogram() +
  labs(title = "Distribution of the Fraction of Nights With Data",
       x = "Fraction of Nights With Data",
       y = "Count")

university_clean |>
  ggplot(aes(x = daytime_sleep)) + 
  geom_histogram() +
  labs(title = "Distribution of Daytime Sleep",
       x = "Daytime Sleep in Minutes",
       y = "Count")
  
  
university_clean |>
  group_by(demo_race) |>
  summarise(count = n(), na.rm = TRUE) |>
  mutate(race_percentage = count / sum(count) * 100) |>
  ggplot(aes(x = "", y = race_percentage, fill = factor(demo_race, labels =
                            c("Underrepresented", "Non-Underrepresented")))) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(title = "Distribution of Underrepresented Vs. Non-Underrepresented
       Students",
       fill = "Race")


university_clean |>
  group_by(demo_gender) |>
  summarise(count = n(), na.rm = TRUE) |>
  mutate(gender_percentage = count / sum(count) * 100) |>
  ggplot(aes(x = "", y = gender_percentage, fill = factor(demo_gender, labels =
                            c("Male", "Female")))) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(title = "Distribution of Gender",
       fill = "Gender") 

university_clean |>
  group_by(demo_firstgen) |> 
  summarise(count = n(), na.rm = TRUE) |>
  mutate(firstgen_percentage = count / sum(count) * 100) |>
  ggplot(aes(x = "", y = firstgen_percentage, fill = factor(demo_firstgen,
                                                            labels =
                            c("Non-First Gen", "First Gen")))) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(title = "Distribution of First-generation Status",
       fill = "First-generation Status")

na_table <- university_clean |>
  group_by(university) |>
  summarize(
    total_count = n(),
    na_count = sum(is.na(term_units)),
    non_na_count = sum(!is.na(term_units))
  ) |>
  kable(digits = 3)
na_table

#a lot of NA values for the Catholic school -> will not use this variable
#for analyses

```

Bivariate EDA of The Response & Key Predictor Variables:

```{r}

university_clean |>
  ggplot(aes(
    x = TotalSleepTime/60,
    y = cum_gpa,
    color = factor(demo_race, labels = c("Underrepresented", "Non-Underrepresented"))
  )) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Cumulative GPA vs. Total Sleep Time by Race",
    x = "Total Sleep Time (hours)",
    y = "Cumulative GPA /4.0",
    color = "Underrepresented Status"
  )


university_clean |>
  filter(!is.na(demo_gender)) |>
  ggplot(aes(
    x = TotalSleepTime,
    y = cum_gpa,
    color = factor(demo_race, labels = c("Male", "Female"))
  )) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Cumulative GPA vs. Total Sleep Time by Gender",
    x = "Total Sleep Time (hours)",
    y = "Cumulative GPA /4.0",
    color = "Gender"
  )

university_clean |>
  filter(!is.na(demo_firstgen)) |>
  ggplot(aes(
    x = TotalSleepTime,
    y = term_gpa,
    color = factor(demo_firstgen, labels = c("Not First-Generation", "First-Generation"))
  )) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Term GPA vs. Total Sleep Time by First-Generation Status",
    x = "Total Sleep Time (hours)",
    y = "Term GPA /4.0",
    color = "First-Generation Status"
  )



university_clean |>
  mutate(threshold_gpa = if_else(term_gpa < cum_gpa, "low", "high"))|>
  ggplot(aes(x = TotalSleepTime/60, y = term_gpa, color = factor(threshold_gpa))) +
  facet_wrap(~ university,
             labeller = labeller(
              university = c("cath_priv" = "Private (Catholic)",
                             "public" = "Public",
                             "stem_priv" = "Private (STEM)"))) + 
  geom_point(alpha = 0.3) +
  geom_smooth(aes(color = factor(threshold_gpa)), method = "lm", se = FALSE) +
  scale_color_manual(values = c("low" = "blue", "high" = "red")) +
  labs(
    title = "Relationship between Total Sleep Time and GPA by University Type",
    x = "Total Sleep Time (hours)",
    y = "Term GPA /4.0",
    color = "GPA Threshold"
    
  )



university_clean |>
  ggplot(aes(
    x = university,
    y = cum_gpa,
    fill = university
  )) +
  geom_boxplot() +
  labs(
    title = "Distribution of Cumulative GPA by University",
    x = "University",
    y = "Cumulative GPA"
  )



university_clean |>
  ggplot(aes(
    x = as.factor(demo_firstgen),
    y = cum_gpa
  )) +
  geom_boxplot() 


university_clean |>
  ggplot(aes(
    x = bedtime_mssd, 
    y = cum_gpa, 
    color = university
  )) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE)



university_clean |>
  ggplot(aes(
    x = daytime_sleep,
    y = term_gpa
  )) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Term GPA vs. Daytime Sleep",
    x = "Daytime Sleep (minutes)",
    y = "Term GPA /4.0"
  )

university_clean |>
  mutate(threshold_gpa = if_else(term_gpa < cum_gpa, "low", "high"))|>
  ggplot(aes(
    x = Zterm_units_ZofZ,
    y = TotalSleepTime,
    color = university
  )) + 
  facet_wrap(~threshold_gpa) +
  geom_point() +
  geom_smooth(method = "lm")

university_clean |>
  mutate(threshold_gpa = if_else(term_gpa < cum_gpa, "low", "high"))|>
  mutate(daytime_sleep_lvl = if_else(daytime_sleep > 60, "high", "low")) |>
  ggplot(aes(
    x = daytime_sleep,
    y = term_gpa,
    color = daytime_sleep_lvl 
  )) +
  facet_wrap(~threshold_gpa) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Term GPA by Daytime Sleep",
    x = "Daytime Sleep (minutes)",
    y = "Term GPA /4.0",
    color = "Daytime Sleep Length"
  )

```

From the graphs above, a few of the key variables seem to have some interaction effects, and a few others do not. The first graph is a scatterplot of the relationship between total sleep time and cumulative GPA, factored by race, where red points were underrepresented students, and blue points were non-underrepresented students. The slopes of the lines best fit for each level are very similar but the slope for the underrepresented students is slightly larger than the slopes for non-underrepresented students, so there might be an interaction effect there that is worth further analysis.

The second graph, is also a scatterplot of the relationship between total sleep time and cumulative GPA, but instead factored by gender, where the red points represent male gender and the blue points represent female gender. The slopes for the line best fit for each level were essentially the same, so there is no obvious interaction effect in this graph that is worth further analysis.

The third graph shows the relationship between a student's term GPA and their total sleep time, but is facet wrapped by the university the student attended. A fourth variable, term_l_cum, is a factor of 0 and 1, where 0 represents that the student's term GPA is greater than or equal to their cumulative GPA, and 1 represents that the student's term GPA is less than their cumulative GPA. This essentially tells us whether the student's term GPA is better or worse than their average GPA. Since this study only collected data during the singular term, this variable will help us determine whether a student with a low term GPA relative to their cumulative GPA is predictive of that student's total sleep time. There are a few interesting things to note of this graph. First, the term GPA of students at the STEM university seem to be more variable than the other two universities, and the total sleep time of the students at the STEM university seem to be on average lower than the other two universities.

In regards to the interaction effects, it seems as if for all three universities there is an interaction effect between students whose term GPA is less than their cumulative and student's whose term GPA is greater than or equal to their cumulative GPA. We assume this, because for all three universities, we fit a line best fit to for both term GPA \< cumulative GPA and vise versa, and the slopes of both lines for all three universities are different. Most notably, for the private catholic university and the public university, the slopes of the level for term GPA \< cumulative GPA is greater than the slopes of the level for term GPA $\ge$ cumulative GPA. This means that there is a potential interaction effect that could be explored further.

Another graph with another potential interaction effect is the sixth graph, which plots the relationship between the mean successive squared difference of bedtimes (bedtime_mssd) and a student's cumulative GPA. The points on this scatterplot were differentiated by university, with red representing the catholic private university, green representing the public university, and blue representing the STEM private university. We fit the line best fit for each of these levels, and the slope of the line for the catholic private university and the stem private university were essentially the same, but the slope of the line for the public university was slightly smaller, which means there could be a potential interaction effect there that is worth further exploration.
